@page "/filetransfer"

@using Microsoft.AspNetCore.Components.Forms
@using BlazorApp2Test.FileAccess
@using BlazorApp2Test.Pages
@using Blazored.Modal

@inject IJSRuntime JSRuntime
@inject IWebHostEnvironment Environment

@inherits Component

<div class="row px-4 pt-2 mt-2">
    <div class="col-12 col-sm-6 col-md-8 py-2">
        <p class="section-name">File Transfer</p>
    </div>
</div>

<div class="mx-4 pb-3 rounded">

    <div class="py-3 ps-2">
        <button class="rounded" @onclick="RefreshPage">Refresh</button>
    </div>
    <div class="rounded py-3 ps-2">
        <InputFile OnChange="HandleSelection" />
        <button class="rounded" @onclick="Upload" disabled="@(!fileSelected)">Upload</button>
    </div>

    <div class="ps-2">
        @if (_file != null)
        {
            @if (_file.Error != null)
            {
                <p class="text-danger">@_file.Error</p>
            }

            @if (_file.IsUploaded)
            {
                <p class="text-success">File uploaded successfully.</p>
            }

            <div class="mt-4 mb-3 ps-2 py-1 pb-2 bg-light rounded">

                <p class="pt-2">Current downloadable files:</p>
                <button class="my-3 mx-1 rounded" @onclick="DeleteAll">Delete All</button>

                @foreach (var file in Directory.GetFiles(Helper.UploadFolderPath))
                {
                    //NOTE: In Helper, @fileName is added to DownloadPath
                    var fileName = Path.GetFileName(file);
                    <p>
                        <a href="@Helper.DownloadPath" download>@fileName</a>
                        <button class="rounded" @onclick="() => ShowDeleteConfirmation(fileName)">delete @fileName</button>
                    </p>
                }
            </div>
        }
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Do you really want to delete @aimed_file?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>



@code {

    //TODO: delete pop up window!

    private IBrowserFile selectedFile;
    private bool fileSelected = false;
    private bool ask = false;
    private string? aimed_file;

    // new file obj instance
    private FileAccess _file = new FileAccess();

    void HandleSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            fileSelected = true;
        }
    }

    private async Task Upload()
    {
        await _file.UploadFile(selectedFile);
    }


    private void DeleteHandler(string f)
    {
        _file.DeleteFile(f);
    }

    private async void DeleteAll()
    {
        await ShowDeleteConfirmation("ALL");
    }

    private async Task ShowDeleteConfirmation(string f)
    {
        aimed_file = f;
        await JSRuntime.InvokeVoidAsync("showModal", "deleteConfirmationModal");
    }

    private void ConfirmDelete()
    {
        if(aimed_file == "ALL")
        {
            foreach (var file in Directory.GetFiles(Helper.UploadFolderPath))
            {
                _file.DeleteFile(Path.GetFileName(file));
            }
        }
        else
        {
            DeleteHandler(aimed_file);
        }
        JSRuntime.InvokeVoidAsync("hideModal", "deleteConfirmationModal");
        aimed_file = null;
    }

}
