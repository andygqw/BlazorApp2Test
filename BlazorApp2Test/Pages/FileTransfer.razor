@page "/filetransfer"

@using Microsoft.AspNetCore.Components.Forms
@using BlazorApp2Test.Pages
@using BlazorApp2Test.FileAccess
@using Blazored.Modal
@using System

@inject ErrorService _errorService
@inject FileAccesses _file

@inherits Component

<PageTitle>GWTool - File</PageTitle>

<div class="row px-4">
    <div class="col-12 col-sm-6 col-md-8 py-2">
        <p class="section-name">File Transfer</p>
    </div>
</div>

<div class="mx-4 pb-3 rounded">

    <div class="rounded py-3 ps-2">
        <InputFile OnChange="HandleSelection" />
        <button class="rounded" @onclick="Upload" disabled="@(!fileSelected)">Upload</button>
    </div>

    <div class="ps-2">

         @if (isUploadSuccess && selectedFile != null)
         {
            <p class="text-success">@selectedFile.Name uploaded successfully.</p>
         }
        <div class="mt-4 mb-3 ps-2 py-1 pb-2 bg-light rounded">

            <p class="pt-2">Current downloadable files:</p>

            @foreach (var file in Directory.GetFiles(Helper.UploadFolderPath))
            {
                var fileName = Path.GetFileName(file);
                <p>
                    <a href="UploadFile/@fileName" download>@fileName</a>
                    <button class="rounded" @onclick="() => ShowDeleteConfirmation(fileName)">delete @fileName</button>
                </p>
            }

            <button class="my-3 mx-1 rounded" @onclick="DeleteAll">Delete All</button>

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="deleteConfirmationModal" style="@($"display: {(DeleteConfirm ? "block" : "none")}")">
   <div class="modal-content text-center fw-bold flex-grow">
      <span class="close" @onclick="CloseModal">&times;</span>
      <div class="mb-2 mx-4">
            @if(isDeleteAll)
            {
                <div>Do you really want to delete all files?</div>
            }
            else
            {
                <div>Do you really want to delete @aimed_file ?</div>
            }
        </div>
      <div>
         <button class="btn btn-secondary rounded-2" @onclick="@CloseModal">Cancel</button>
            <button class="btn btn-danger" @onclick="isDeleteAll ? ConfirmDeleteAll : ConfirmDelete">Delete</button>
      </div>
            
   </div>
</div>

<div class="modal" id="fileNameDupModal" style="@($"display: {(DupConfirm ? "block" : "none")}")">
   <div class="modal-content text-center fw-bold">
      <span class="close" @onclick="CloseModal">&times;</span>
      <div class="mb-2 mx-4">
            File @(selectedFile?.Name ?? "unknown") already exists, do you want to replace it?
      </div>
      <div>
            <button class="btn btn-secondary rounded-2" @onclick="DupHandler">No</button>
            <button class="btn btn-danger" @onclick="RepHandler">Yes</button>
      </div>
   </div>
</div>

@code {

    private IBrowserFile? selectedFile;
    private bool fileSelected = false;
    private string? aimed_file = null;


    private bool DeleteConfirm = false;
    private bool DupConfirm = false;
    private bool isDeleteAll = false;
    private bool isUploadSuccess = false;

    void HandleSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            fileSelected = true;
        }
        else
        {
            _errorService.ShowModal("Selected file doesn't exist");
        }
    }

    private async Task Upload()
    {
        try
        {
            fileSelected = false;

            if (selectedFile == null)
            {
                throw new Exception("Something wrong with file selection");
            }

            foreach (var f in Directory.GetFiles(Helper.UploadFolderPath))
            {
                if (Path.GetFileName(f) == selectedFile.Name)
                {
                    DupConfirm = true;
                    return;
                }
            }

            if(await _file.UploadFile(selectedFile, true) == Helper.ReturnGood)
            {
                isUploadSuccess = true;
            }
            else
            {
                isUploadSuccess = false;
            }
        }
        catch (Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private async Task DupHandler()
    {
        try
        {
            if (selectedFile == null)
            {
                throw new Exception("Something wrong with file selection");
            }

            CloseModal();
            await _file.UploadFile(selectedFile, false);
            fileSelected = false;

        }catch(Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private async Task RepHandler()
    {
        try
        {
            if (selectedFile == null)
            {
                throw new Exception("Something wrong with file selection");
            }
            CloseModal();
            _file.DeleteFile(selectedFile.Name);
            await _file.UploadFile(selectedFile, true);
            fileSelected = false;

        }catch(Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private void ShowDeleteConfirmation(string fName)
    {
        aimed_file = fName;
        DeleteConfirm = true;
    }

    private void DeleteHandler(string f)
    {
        try
        {
            _file.DeleteFile(f);
        }
        catch (Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private void DeleteAll()
    {
        isDeleteAll = true;
        DeleteConfirm = true;
    }

    private void ConfirmDelete()
    {
        try
        {
            if (aimed_file == null)
            {
                throw new Exception("File aimed failed");
            }
            CloseModal();
            _file.DeleteFile(aimed_file);
        }
        catch (Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private void ConfirmDeleteAll()
    {
        try
        {
            CloseModal();
            aimed_file = null;
            _file.DeleteAllFiles();
        }
        catch (Exception ex)
        {
            _errorService.ShowModal(ex.Message);
        }
    }

    private void CloseModal()
    {
        DeleteConfirm = false;
        DupConfirm = false;
    }
}